# Supabase Row Level Security (RLS) Setup

Follow these steps to configure the necessary Row Level Security (RLS) policies for your `survey_responses` table. This is a critical security step that allows anonymous users to submit the survey and view the results securely, without giving them access to your database.

### 1. Enable Row Level Security (RLS)

First, you must enable RLS on your table if it isn't already.

1.  Navigate to **Authentication** > **Policies** in your Supabase dashboard.
2.  Find the `survey_responses` table.
3.  If it says "RLS is disabled", click the **"Enable RLS"** button.

### 2. Create the Table (If Needed)

If you haven't created the table yet, or if you need to reset it, run this query in the **SQL Editor**. This script will safely delete any old version of the table and its dependencies before creating the new one.

```sql
-- This line will safely delete the old table if it exists, along with any
-- dependent objects like views.
DROP TABLE IF EXISTS public.survey_responses CASCADE;

-- This creates the new, updated table structure.
CREATE TABLE public.survey_responses (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    -- Section 1
    employment_type text,
    years_experience text,
    job_role_type text,
    -- Section 2
    vacation_days_taken text,
    postponed_leave text,
    cancelled_leave text,
    postpone_cancel_reasons jsonb,
    leave_emotions text,
    faked_illness text,
    -- Section 3
    manager_takes_leave text,
    team_attitude_rating text,
    feel_judged text,
    -- Section 4
    avoid_leave_reasons jsonb,
    leave_expectations jsonb,
    -- Section 5
    guilt_free_factors text,
    performance_impact text,
    manager_app_features text,
    -- Backup
    raw_responses jsonb
);

-- Optional: Add comments to describe each column
COMMENT ON COLUMN public.survey_responses.employment_type IS 'Q1: Employment Type';
COMMENT ON COLUMN public.survey_responses.years_experience IS 'Q2: Years of Experience';
COMMENT ON COLUMN public.survey_responses.job_role_type IS 'Q3: Job Role Type';
COMMENT ON COLUMN public.survey_responses.vacation_days_taken IS 'Q4: Vacation Days Taken';
COMMENT ON COLUMN public.survey_responses.postponed_leave IS 'Q5a: Ever postponed a planned leave?';
COMMENT ON COLUMN public.survey_responses.cancelled_leave IS 'Q5c: Ever cancelled a planned leave?';
COMMENT ON COLUMN public.survey_responses.postpone_cancel_reasons IS 'Q5b: Reasons for postponing or cancelling leave';
COMMENT ON COLUMN public.survey_responses.leave_emotions IS 'Q6: Emotions associated with leave';
COMMENT ON COLUMN public.survey_responses.faked_illness IS 'Q7: Faked illness for leave';
COMMENT ON COLUMN public.survey_responses.manager_takes_leave IS 'Q8: Manager''s leave behavior';
COMMENT ON COLUMN public.survey_responses.team_attitude_rating IS 'Q9: Team attitude rating';
COMMENT ON COLUMN public.survey_responses.feel_judged IS 'Q10: Feeling judged for taking time off';
COMMENT ON COLUMN public.survey_responses.avoid_leave_reasons IS 'Q11: Top reasons for avoiding leave';
COMMENT ON COLUMN public.survey_responses.leave_expectations IS 'Q12: Work expectations during leave';
COMMENT ON COLUMN public.survey_responses.guilt_free_factors IS 'Q14: Factors for guilt-free breaks';
COMMENT ON COLUMN public.survey_responses.performance_impact IS 'Q15: Impact of leave on performance';
COMMENT ON COLUMN public.survey_responses.manager_app_features IS 'Q16: Useful manager app features';
COMMENT ON COLUMN public.survey_responses.raw_responses IS 'A complete JSON backup of the raw response object from the client.';
```

### 3. Create Security Policies

After enabling RLS, no one can access the table until you create policies. Go to the **SQL Editor** and run the following two queries one by one.

#### Policy 1: Allow Anonymous Insert Access
This policy allows anyone (the `anon` role) to insert a new row into the `survey_responses` table. This is required for the survey form to save new submissions.

```sql
CREATE POLICY "Allow anonymous survey submissions"
ON public.survey_responses
FOR INSERT
TO anon
WITH CHECK (true);
```

#### Policy 2: Allow Anonymous Read Access
This policy allows anyone (the `anon` role) to read (select) all data from the table. This is required for the public `results.html` page to display the responses.

```sql
CREATE POLICY "Allow anonymous read access to all responses"
ON public.survey_responses
FOR SELECT
TO anon
USING (true);
```

After running these queries, your survey and the new results page will be able to access the data securely. 